<h1 align="center">Документация к установке проекта</h1>

# Установка РHP

Вам пондаобится бинарник PHP 7.3.x с Zend Thread Safety, чтобы скомпилировать php с pthreads

<h1>Как это сделать?</h1>

[Здесь подробно описано, как это сделать](https://gist.github.com/lokisho/8ee9e73c92fdb9bce3ea501e7d5217c7)
<br>Ну а для ленивых, в storage лежит архив с моим бинарником.

#Как работает проект?

С помощью REST API мы направляем ИНН, введённый пользователелем, в контроллер.

<b>Что там просиходит?</b>

Web нельзя поднять на бинарнике с pthreads, так как он полностью обрезает SApi, что является абсолютно
нормальным поведением. Поэтому, мы запускаем Laravel на одном бинарнике, а выполняем операцию по сбору данных на другой.
pthreads - это бибилиотека для работы с потоками, благодаря ей, задачи исполняются параллельно.

#Пыха же однопоточное...<p size="1">g</p>

Да, верно. php хоть и однопоточный, потоки там нативно никак пока что хоть и не используешь, зато можно общаться между 
потоками с помощью типов данных, что на намекает на serialize)00))0

При запуске такого Франкенштейна, я отправляю 3 Threaded в разные потоки. Почему? Задачи "стакаются", если слать их в один поток,
тогда толку от pthreads нет вообще. 

<b>Почему открыто 2 порта под Laravel?</b>

Дополнительно запущен сервер для реализации API.
Дело в том, что я использую Symfony/Process для получения данных, которые отдают потоки. Одна из задач использует API этого же проекта. А если говорить проще ,
Пока мы ждём отклика от задачи, мы не можем отдать ответ со своего апи. Поток просто замирает. Но 2 параллельной задачи делает параллельку бесполезной. Так, я получаю данные с Dadata, базы, и в последней беру фейковые
 данные, которые были мне отдаёт другой сайт. То есть, по факту, это 3 разных потока, которые выполняют задачи параллельно друг другу.

5 неудачных попыток блокируют сервис, который вызывает ошибку, а затем, "к концу часа", как было и описано в тз, они используются вновь.
Реализация лежит в App\Console\Kernel. Ну за дизайн я вообще ничего говорить не буду. Ненавижу фронт, но  Vue нравится.

## Установка проекта.

<ol start="1">
    <li>
        Установите все зависимости с помощью Composer<br>
        <code>
            composer install
        </code>
    </li>
    <li>
        NPM || yarn (Frontend)<br>
        <code>
            npm install
        </code>
        или
        <code>
            yarn install
        </code>
    </li>
    <li>
        Сгенерируйте .env
        <br>
        <code>
            cp .env.example .env
        </code>
        <br>
        Обратите внимание, что Вам необходимо запоолнить некоторые поля:
        <pre>
            <code>
//Чтобы получить API токен, зарегистрируйтесь на сайте dadata.ru
DADATA_TOKEN=
//Количество потоков
THREADS=4
//Полный путь до PHP Runtime с pthreads
PTHREADS_PHP_RUNTIME=/home/zloynick/bin/php7/bin/php
//базу данных тоже необходимо настроить.
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=companies
DB_USERNAME=
DB_PASSWORD=
            </code>
        </pre>
    </li>
    <li>
        Сгенерируйте ключ приложения
        <br>
        <code>
            php artisan key:generate
        </code>
    </li>
    <li>
        Установите себе "голый" Redis и настройте .env так, как показано ниже:
        <pre>
            <code>
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
            </code>
        </pre>
    </li>
    <li>
        Установите базу:
        <br>
        <code>
            php artisan migrate
        </code>
    </li>
    <li>
        Заполните базу.
        <pre>vendor/bin/phpunit tests/Feature/FillDatabase.php</pre>
    </li>
    <li>
        Запускайте!
        <br>
        <code>
            ./start.sh
        </code>
    </li>
</ol>
